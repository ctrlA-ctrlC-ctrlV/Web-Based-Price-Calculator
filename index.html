<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garden Room Price Calculator</title>
  <link href="dist/output.css" rel="stylesheet">
  <meta name="description" content="A shareable, single-file price calculator for garden rooms. Adjust the config to match your pricing and share the link—no backend required." />
  <style>
    /* Print-friendly */
    @media print {
      .no-print { display: none !important; }
      .print-block { display: block !important; }
    }
    .number-input::-webkit-outer-spin-button, .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Garden Room Price Calculator</h1>
        <p class="text-slate-600"><!-- Single-file, shareable. Adjust inputs and send the link to clients. --></p>
      </div>
      <div class="flex items-center gap-2 no-print">
        <select id="currency" class="px-3 py-2 rounded-xl border border-slate-300 bg-white shadow-sm">
          <option value="EUR">€ EUR</option>
          <option value="GBP">£ GBP</option>
        </select>
        <button id="shareBtn" class="px-4 py-2 rounded-xl bg-slate-900 text-white shadow hover:bg-slate-800">Copy shareable link</button>
        <button id="printBtn" class="px-4 py-2 rounded-xl border border-slate-300 bg-white shadow hover:bg-slate-100">Print / Save PDF</button>
      </div>
    </header>
    
    <!-- Config panel (edit defaults here) -->
    <details class="mt-4 no-print">
      <summary class="cursor-pointer text-sm text-slate-600">Pricing config (internal, 顾客看不到): tweak default rates</summary>
      <div class="grid md:grid-cols-3 gap-4 mt-3 text-sm">
        <label class="block">Base rate €/m²
          <input type="number" step="1" id="cfg_baseRate" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">fixed charge
          <input type="number" step="1" id="cfg_fixedCharge" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">Cladding Rate
          <input type="number" step="1" id="cfg_cladRate" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">Window Fixed Fee
          <input type="number" step="1" id="cfg_windowCharge" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">Window rate €/m²
          <input type="number" step="1" id="cfg_windowRate" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">Delivery free radius (km)
          <input type="number" step="1" id="cfg_freeKm" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">Delivery rate €/km beyond
          <input type="number" step="1" id="cfg_ratePerKm" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">VAT %
          <input type="number" step="0.1" id="cfg_vat" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
        <label class="block">Discount % (default 0)
          <input type="number" step="0.5" id="cfg_discount" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
        </label>
      </div>
    </details>

    <!-- Left: Inputs -->
    <main class="mt-6 grid md:grid-cols-2 gap-6">      
      <section class="bg-white rounded-2xl shadow p-4 md:p-6">
        <h2 class="text-xl font-semibold mb-4">Project details</h2>
        <div class="grid grid-cols-2 gap-4">
            <label class="block col-span-1">Width (m)
                <input type="number" step="0.1" id="width" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>

            <label class="block col-span-1">Depth (m)
                <input type="number" step="0.1" id="depth" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>

            <label class="block col-span-2">Cladding Size (m²)
                <input type="number" step="0.1" id="cladding" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>

            <!--Bathroom-->
            <section class="col-span-2"> 
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Bathroom</h3>
            </div>
            <label class="block col-span-2">Bathroom type 1 (Toliet + Sink)
                <input type="number" step="0.1" id="bathroom_1" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>

            <label class="block col-span-2">Bathroom type 2 (Toliet + Sink+ Shower)
                <input type="number" step="0.1" id="bathroom_2" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <p style="margin-bottom: 10px;"></p>

            <!--Electrical-->
            <section class="col-span-2"> 
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Electrical</h3>
            </div>
            <label class="block col-span-2">Switch (quantity)
                <input type="number" step="0.1" id="switch" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>

            <label class="block col-span-2">Double Socket (quantity)
                <input type="number" step="0.1" id="d_socket" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <p style="margin-bottom: 10px;"></p>

            <!--Internal-->
            <section class="col-span-2">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Internal</h3>
            </div>
            <label class="block col-span-2">Internal Door (quantity)
                <input type="number" step="0.1" id="inner_door" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            
            <div class="grid grid-cols-2 gap-4 col-span-2">
                <label class="block">
                    Wall Type
                    <select id="inner_wall_type"
                    class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300">
                    <option value="none">None</option>
                    <option value="inner_wall_type_p">Panel Wall</option>
                    <option value="inner_wall_type_s">Skimmed & Painted Wall</option>
                    </select>
                </label>

                <label class="block">
                    Wall Size (m)
                    <input type="number" step="0.1" id="wall_quan"
                    class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
                </label>
            </div>
            <p style="margin-bottom: 20px;"></p>
          
            <!-- Windows Module -->
            <section class="col-span-2">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Windows</h3>
                <button id="addWindowBtn"
                class="no-print px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">
                + Add window
                </button>
            </div>

            <div id="windowsList" class="space-y-3"></div>

            <!-- Template for each window row -->
            <template id="windowRowTpl">
            <div class="grid grid-cols-12 gap-3 p-3 bg-white rounded-2xl border border-slate-200">
                <div class="col-span-5">
                <label class="text-sm font-medium">Width (m)
                    <input type="number" step="0.01" min="0"
                        class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"
                        data-field="width" placeholder="e.g. 1.20" />
                </label>
                </div>
                <div class="col-span-5">
                <label class="text-sm font-medium">Height (m)
                    <input type="number" step="0.01" min="0"
                        class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"
                        data-field="height" placeholder="e.g. 1.00" />
                </label>
                </div>
                <div class="col-span-2 flex items-end">
                <button class="no-print w-full px-3 py-2 rounded-xl border border-red-300 text-red-700 hover:bg-red-50"
                        data-action="remove">Del</button>
                </div>
            </div>
            </template>
            <p style="margin-bottom: 2px;"></p>
            
            <!--Door-->
            <label class="block col-span-2">External Door
                <select id="ex_door" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300">
                    <option value="minimal">Minimal (door only)</option>
                    <option value="bi-fold">Bi-fold doors</option>
                    <option value="panoramic">Panoramic sliders</option>
                </select>
            </label>
            <p style="margin-bottom: 20px;"></p>

            <!--Floor-->
            <section class="col-span-2"> 
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Floor</h3>
            </div>
            <div class="grid grid-cols-2 gap-4 col-span-2">
                <label class="block">
                    Floor Type
                    <select id="floor_type"
                    class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300">
                    <option value="none">None</option>
                    <option value="wooden">Wooden</option>
                    <option value="tile">Tile</option>
                    </select>
                </label>

                <label class="block">
                    Floor Size
                    <input type="number" step="0.1" id="floor_size"
                    class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
                </label>
            </div>
            <p style="margin-bottom: 10px;"></p>

            <!--Delivery-->
            <section class="col-span-2"> 
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Delivery</h3>
            </div>
            <label class="block col-span-2">Delivery distance from base (km)
                <input type="number" step="1" id="distance" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <p style="margin-bottom: 10px;"></p>

            <!--Extras-->
            <section class="col-span-2"> 
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Extras</h3>
            </div>
            <label class="block col-span-2">100mm EPS insulation sqm
                <input type="number" step="1" id="ex_EPSInsulation" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <label class="block col-span-2">Render finish sqm
                <input type="number" step="1" id="ex_renderFinish" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <label class="block col-span-2">Extra steel door
                <input type="number" step="1" id="ex_steelDoor" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
        </div>
      </section>

      <!-- Right: Summary -->
      <section class="bg-white rounded-2xl shadow p-4 md:p-6">
        <h2 class="text-xl font-semibold mb-4">Estimate</h2>
        <div id="summary" class="space-y-3"></div>
        <div class="mt-6 grid md:grid-cols-2 gap-3">
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-sm text-slate-600">Notes (shows on print/share)</p>
            <textarea id="notes" rows="5" class="w-full mt-2 px-3 py-2 rounded-xl border border-slate-300" placeholder="Lead time, inclusions/exclusions, planning notes…"></textarea>
          </div>
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-sm text-slate-600">Quote details</p>
            <label class="block mt-2 text-sm">Client name
              <input id="clientName" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <label class="block mt-2 text-sm">Quote ID
              <input id="quoteId" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
            <label class="block mt-2 text-sm">Discount % (optional)
              <input type="number" step="0.5" id="discountPct" class="number-input mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" />
            </label>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-8 text-center text-xs text-slate-500">
      <p class="print-block hidden">Generated by the Garden Room Price Calculator</p>
      <p class="no-print">© 2025 SDeal • Created by Zhaoxiang Qiu</p>
    </footer>
  </div>


    <script>
    // --- Configurable pricing defaults ---
    const defaults = {
      currency: 'EUR',
      baseRatePerM2: 1200,       // base build €/m²
      fixedCharge: 6000,
      cladRate: 80,
      bathTypeOneCharge: 2500,
      bathTypeTwoCharge: 4500,
      windowCharge: 500,
      windowRate: 400,
      floor: { none: 0, wooden: 30, tile: 50 },
      switch: 50,
      doubeSocket: 60,
      innerDoorChar: 500,
      innerWallType: { none: 0, inner_wall_type_p: 200, inner_wall_type_s:300 },
      ex_door: { minimal: 600, standard: 1800, panoramic: 3800, 'bi-fold': 5200 },
      floor: { none: 0, wooden: 40, tile: 60},
      deliveryFreeKm: 30,
      deliveryRatePerKm: 2.2,    // €/km beyond free radius
      ex_ESPInstRate: 40,
      ex_renderRate: 120,
      ex_steelDoorCharge: 500,
      vatPct: 0,
      discountPct: 0
    };

    // --- Helpers ---
    const qs = (sel, root = document) => root.querySelector(sel);
    const fmtCurrency = (v) => {
      const cur = qs('#currency').value;
      const sym = cur === 'GBP' ? '£' : '€';
      return sym + new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 }).format(v);
    };

    function areaM2() {
      const w = parseFloat(qs('#width').value) || 0;
      const d = parseFloat(qs('#depth').value) || 0;
      return Math.max(0, w * d);
    }

    async function getRate() {
      try {
        const res = await fetch("https://api.exchangerate.host/latest?base=GBP&symbols=EUR");
        const data = await res.json();
        const rate = data.rates.EUR;
        return rate; // <-- return value
      } catch (err) {
        console.error("Error fetching exchange rate:", err);
        return null;
      }
    }

    function calcWinRow(wEl, hEl) {
        const w = parseFloat(wEl.value) || 0;
        const h = parseFloat(hEl.value) || 0;
        const area = (w > 0 && h > 0) ? (w * h) : 0;
        const price = area > 0 ? (area * defaults.windowRate) + defaults.windowCharge : 0;
        
        return {area, price};
    }

    function getWinData() {
        const list = qs('#windowsList');
        if (!list) {
            console.warn('#windowsList not found');
            return { winPriceSum: 0, winAreaSum: 0, winCount: 0 };
        }
        let winPriceSum = 0;

        [...list.children].forEach(row => {
            const wEl = row.querySelector('[data-field="width"]');
            const hEl = row.querySelector('[data-field="height"]');
            if (!wEl || !hEl) return;

            const { area, price } = calcWinRow(wEl, hEl);

            if (area > 0) {
                winPriceSum += price;
            }       
        });
        
        return winPriceSum;
    }

    function addWindow(prefill = { width: '', height: '' }) {
        const list = qs('#windowsList');
        const rowTpl = qs('#windowRowTpl');

        const node = rowTpl.content.firstElementChild.cloneNode(true);
        const wEl = qs('[data-field="width"]', node);
        const hEl = qs('[data-field="height"]', node);
        const rmBtn = qs('[data-action="remove"]', node);

        if (prefill.width !== undefined)  wEl.value = prefill.width;
        if (prefill.height !== undefined) hEl.value = prefill.height;

        ['input','change'].forEach(ev => {
            wEl.addEventListener(ev, compute);
            hEl.addEventListener(ev, compute);
        });

        rmBtn.addEventListener('click', () => { node.remove(); });

        list.appendChild(node);
        compute();
    }

    function compute() {
        const a = areaM2();

        // Fetch config panel value
        const baseRate = parseFloat(qs('#cfg_baseRate').value) || defaults.baseRatePerM2;
        const fixedCharge = parseFloat(qs('#cfg_fixedCharge').value) || defaults.fixedCharge;
        const cladRate = parseFloat(qs('#cfg_cladRate').value) || defaults.cladRate;
        const windowCharge = parseFloat(qs('#cfg_windowCharge').value) || defaults.windowCharge;;
        const windowRate = parseFloat(qs('#cfg_windowRate').value) || defaults.windowRate;
        const freeKm = parseFloat(qs('#cfg_freeKm').value) || defaults.deliveryFreeKm;
        const rateKm = parseFloat(qs('#cfg_ratePerKm').value) || defaults.deliveryRatePerKm;
        const vatPct = parseFloat(qs('#cfg_vat').value) || defaults.vatPct;
        const defaultDiscountPct = parseFloat(qs('#cfg_discount').value) || defaults.discountPct;

        // Fetch Left Inputs
        const cladSize = parseFloat(qs('#cladding').value) || 0;
        const bathTypeOne = qs('#bathroom_1').value || 0;
        const bathTypeTwo = qs('#bathroom_2').value || 0;
        const eSwitch = qs('#switch').value;
        const dSocket = qs('#d_socket').value;
        const innerDoor = qs('#inner_door').value || 0;
        const innerWallType = qs('#inner_wall_type').value;
        const innerWallQuan = qs('#wall_quan').value || 0;
        const exDoor = qs('#ex_door').value;
        const floorType = qs('#floor_type').value;
        const floorSize = qs('#floor_size').value || 0;
        const distance = parseFloat(qs('#distance').value) || 0;
        const EPSInsulation = parseFloat(qs('#ex_EPSInsulation').value) || 0;
        const renderFinish = parseFloat(qs('#ex_renderFinish').value) || 0;
        const steelDoor = qs('#ex_steelDoor').value || 0;

        // Calculation of non extra
        const base = a * baseRate + fixedCharge;
        const cladCost = cladSize * cladRate;
        const bathCost = bathTypeOne * defaults.bathTypeOneCharge + bathTypeTwo * defaults.bathTypeTwoCharge ; // FIX THIS
        const eleCost = eSwitch * defaults.switch + dSocket * defaults.doubeSocket;
        const innerDoorCost = innerDoor * defaults.innerDoorChar;
        const innerWallCost = defaults.innerWallType[innerWallType] * innerWallQuan;
        const windowCost = getWinData();
        const exterDoorCost = defaults.ex_door[exDoor];
        const floorCost = defaults.floor[floorType] * floorSize; //floor type * floor size
        const deliveryExtraKm = Math.max(0, distance - freeKm);;
        const deliverCost = deliveryExtraKm * rateKm;

        // Calculation of extra
        const ex_espCost = EPSInsulation * defaults.ex_ESPInstRate;
        const ex_renderCost = renderFinish * defaults.ex_renderRate;
        const ex_steelDoorCost = steelDoor * defaults.ex_steelDoorCharge;

        // Total Calculation
        let noneExtraSubtotal = base + cladCost + bathCost + eleCost + innerDoorCost + innerWallCost + windowCost + exterDoorCost + floorCost + deliverCost;
        let extraSubtotal  = ex_espCost + ex_renderCost + ex_steelDoorCost;
        let subtotal = noneExtraSubtotal + extraSubtotal;

        const discountPct = parseFloat(qs('#discountPct').value);
        const appliedDiscountPct = isFinite(discountPct) && discountPct >= 0 ? discountPct : defaultDiscountPct;
        const discountAmt = subtotal * (appliedDiscountPct / 100);

        const net = subtotal - discountAmt;
        const vat = vatPct > 0 ? net * (vatPct / 100) : 0;
        const total = net + vat;

        const lines = [
            { label: `Base build (${a.toFixed(2)} m² @ ${fmtCurrency(baseRate)} /m²)`, amount: base },
            { label: `Cladding (${cladSize.toFixed(2)} m²)`, amount: cladCost },
            { label: `Bathrooms`, amount: bathCost },
            { label: `Electrical`, amount: eleCost },
            { label: `Internal doors`, amount: innerDoorCost },
            { label: `Internal walls`, amount: innerWallCost },
            { label: `Windows`, amount: windowCost },
            { label: `External door`, amount: exterDoorCost },
            { label: `Flooring`, amount: floorCost },
            { label: deliveryExtraKm > 0 ? `Delivery (${deliveryExtraKm} km beyond ${freeKm} km)` : 'Delivery (within free radius)', amount: deliverCost },
        ];

        renderSummary({ a, lines, subtotal, discountPct: appliedDiscountPct, discountAmt, net, vatPct, vat, total });
        updateUrlParams();
        persistToLocalStorage();
    }

    function renderSummary(model) {
        const s = qs('#summary');
        s.innerHTML = '';

        // Safety guard to avoid runtime errors
        const lines = Array.isArray(model.lines) ? model.lines : [];
        const grid = document.createElement('div');
        grid.className = 'divide-y divide-slate-200 rounded-xl border border-slate-200 overflow-hidden';

        lines.forEach(line => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between px-4 py-3 bg-white';
            row.innerHTML = `<span class="text-sm">${line.label}</span><span class="font-medium">${fmtCurrency(line.amount || 0)}</span>`;
            grid.appendChild(row);
        });

        const sub = document.createElement('div');
        sub.className = 'flex items-center justify-between px-4 py-3 bg-slate-50';
        sub.innerHTML = `<span class="text-sm">Subtotal</span><span class="font-medium">${fmtCurrency(model.subtotal || 0)}</span>`;

        const disc = document.createElement('div');
        disc.className = 'flex items-center justify-between px-4 py-3 bg-white';
        disc.innerHTML = `<span class="text-sm">Discount (${(model.discountPct ?? 0).toFixed(1)}%)</span><span class="font-medium">- ${fmtCurrency(model.discountAmt || 0)}</span>`;

        const net = document.createElement('div');
        net.className = 'flex items-center justify-between px-4 py-3 bg-slate-50';
        net.innerHTML = `<span class="text-sm">Net</span><span class="font-medium">${fmtCurrency(model.net || 0)}</span>`;

        const vat = document.createElement('div');
        vat.className = 'flex items-center justify-between px-4 py-3 bg-white';
        vat.innerHTML = `<span class="text-sm">VAT (${(model.vatPct ?? 0).toFixed(1)}%)</span><span class="font-medium">${fmtCurrency(model.vat || 0)}</span>`;

        const total = document.createElement('div');
        total.className = 'flex items-center justify-between px-4 py-4 bg-slate-900 text-white';
        total.innerHTML = `<span class="text-base font-semibold tracking-wide">Total (incl. VAT)</span><span class="text-lg font-bold">${fmtCurrency(model.total || 0)}</span>`;

        s.appendChild(grid);
        s.appendChild(sub);
        s.appendChild(disc);
        s.appendChild(net);
        s.appendChild(vat);
        s.appendChild(total);
    }

    function updateUrlParams() {
        const params = new URLSearchParams();

        // Plain inputs (left panel + quote details)
        [
            'width','depth','cladding',
            'bathroom_1','bathroom_2',
            'switch','d_socket',
            'inner_door','inner_wall_type','wall_quan',
            'ex_door',
            'floor_type','floor_size',
            'distance',
            'ex_EPSInsulation','ex_renderFinish','ex_steelDoor',
            'clientName','quoteId','notes',
            'discountPct'
        ].forEach(id => {
            const el = qs('#' + id);
            if (!el) return;
            const val = el.value;
            if (val !== '' && val != null) params.set(id, val);
        });

        // Currency
        params.set('currency', qs('#currency').value);

        // Config (new mapping)
        [
            ['cfg_baseRate','baseRatePerM2'],
            ['cfg_fixedCharge','fixedCharge'],
            ['cfg_cladRate','cladRate'],
            ['cfg_windowCharge','windowCharge'],
            ['cfg_windowRate','windowRate'],
            ['cfg_freeKm','freeKm'],
            ['cfg_ratePerKm','rateKm'],
            ['cfg_vat','vat'],
            ['cfg_discount','disc'],
        ].forEach(([id,key]) => {
            const el = qs('#' + id);
            if (!el) return;
            const v = el.value;
            if (v !== '' && v != null) params.set(key, v);
        });

        // Windows: serialize as "w1x h1,w2x h2,..."
        const list = qs('#windowsList');
        if (list) {
            const parts = [];
            [...list.children].forEach(row => {
            const wEl = row.querySelector('[data-field="width"]');
            const hEl = row.querySelector('[data-field="height"]');
            const w = parseFloat(wEl?.value) || 0;
            const h = parseFloat(hEl?.value) || 0;
            if (w > 0 && h > 0) parts.push(`${w}x${h}`);
            });
            if (parts.length) params.set('windows', parts.join(','));
            else params.delete('windows');
        }

        const newUrl = location.pathname + '?' + params.toString();
        history.replaceState(null, '', newUrl);
    }

    function loadFromUrlParams() {
        const params = new URLSearchParams(location.search);
        if (![...params.keys()].length) return false; // nothing to load

        const setIf = (id, key = id) => {
            if (!params.has(key)) return;

            const el = qs('#' + id);
            if (!el) {
                console.warn('[load:url] missing element for id:', id);
                return;
            }
            el.value = params.get(key);
            // DEBUG
            console.log('[load:url] set', id, '=>', el.value);
        };

        // Plain inputs
        [
            'width','depth','cladding',
            'bathroom_1','bathroom_2',
            'switch','d_socket',
            'inner_door','inner_wall_type','wall_quan',
            'ex_door',
            'floor_type','floor_size',
            'distance',
            'ex_EPSInsulation','ex_renderFinish','ex_steelDoor',
            'clientName','quoteId','notes',
            'discountPct'
        ].forEach(id => setIf(id));

        // Currency
        setIf('currency','currency');

        // Config mapping
        const cfgMap = {
            cfg_baseRate: 'baseRatePerM2',
            cfg_fixedCharge: 'fixedCharge',
            cfg_cladRate: 'cladRate',
            cfg_windowCharge: 'windowCharge',
            cfg_windowRate: 'windowRate',
            cfg_freeKm: 'freeKm',
            cfg_ratePerKm: 'rateKm',
            cfg_vat: 'vat',
            cfg_discount: 'disc',
        };
        Object.entries(cfgMap).forEach(([id,key]) => setIf(id,key));

        // Windows: parse "w1xh1,w2xh2,..."
        if (params.has('windows')) {
            const str = params.get('windows') || '';
            const pairs = str.split(',').map(s => s.trim()).filter(Boolean);

            const list = qs('#windowsList');
            if (!list) {
                console.warn('[load:url] #windowsList not found; windows skipped');
            } else {
                list.innerHTML = ''; // clear existing rows
                pairs.forEach(p => {
                    const [wStr, hStr] = p.split('x');
                    const w = parseFloat(wStr);
                    const h = parseFloat(hStr);
                    if (isFinite(w) && isFinite(h) && w > 0 && h > 0) {
                        if (typeof addWindow === 'function') {
                            addWindow({ width: w, height: h }); // your addWindow should attach listeners & call compute()
                        } else {
                            console.warn('[load:url] addWindow() not available yet');
                        }
                    }
                });
            }
        }
    }

    function persistToLocalStorage() {
        const data = {};

        // Plain inputs (left panel + quote details)
        [
            'width','depth','cladding',
            'bathroom_1','bathroom_2',
            'switch','d_socket',
            'inner_door','inner_wall_type','wall_quan',
            'ex_door',
            'floor_type','floor_size',
            'distance',
            'ex_EPSInsulation','ex_renderFinish','ex_steelDoor',
            'clientName','quoteId','notes',
            'discountPct',
            'currency',
            'cfg_baseRate','cfg_fixedCharge','cfg_cladRate',
            'cfg_windowCharge','cfg_windowRate',
            'cfg_freeKm','cfg_ratePerKm','cfg_vat','cfg_discount'
        ].forEach(id => {
            const el = qs('#' + id);
            if (el) data[id] = el.value;
        });

        // Windows array: [ {width: 1.2, height: 1.0}, ... ]
        const list = qs('#windowsList');
        if (list) {
            const arr = [];
            [...list.children].forEach(row => {
            const wEl = row.querySelector('[data-field="width"]');
            const hEl = row.querySelector('[data-field="height"]');
            const w = parseFloat(wEl?.value) || 0;
            const h = parseFloat(hEl?.value) || 0;
            if (w > 0 && h > 0) arr.push({ width: w, height: h });
            });
            data.windows = arr;
        }

        localStorage.setItem('gr_calc', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        try {
            const data = JSON.parse(localStorage.getItem('gr_calc') || '{}');

            // Plain inputs
            Object.entries(data).forEach(([id, val]) => {
            if (id === 'windows') return; // handled separately
            const el = qs('#' + id);
            if (el && val != null) el.value = val;
            });

            // Windows restore
            if (Array.isArray(data.windows)) {
            const list = qs('#windowsList');
            if (list) list.innerHTML = '';
            data.windows.forEach(win => {
                if (isFinite(win.width) && isFinite(win.height)) {
                addWindow({ width: win.width, height: win.height });
                }
            });
            }
        } catch (err) {
            console.error('Error loading localStorage:', err);
        }
    }
    
    function initDefaults() {
        // Inputs sensible defaults
        qs('#width').value = 4;
        qs('#depth').value = 3;
        qs('#currency').value = defaults.currency;
        // Config defaults
        qs('#cfg_baseRate').value = defaults.baseRatePerM2;
        qs('#cfg_fixedCharge').value = defaults.fixedCharge;
        qs('#cfg_windowCharge').value = defaults.windowCharge;
        qs('#cfg_windowRate').value = defaults.windowRate;//
        qs('#cfg_freeKm').value = defaults.deliveryFreeKm;
        qs('#cfg_ratePerKm').value = defaults.deliveryRatePerKm;
        qs('#cfg_vat').value = 13.5;
        qs('#cfg_discount').value = defaults.discountPct;
    }

    function copyLink() {
      navigator.clipboard.writeText(location.href).then(() => {
        const btn = qs('#shareBtn');
        const old = btn.textContent;
        btn.textContent = 'Link copied!';
        setTimeout(()=>btn.textContent=old, 1200);
      }).catch(()=>{
        alert('Could not copy. Manually copy the URL from the address bar.');
      });
    }

    // Events: User input
    ['input','change'].forEach(ev => {
        document.body.addEventListener(ev, (e) => {
        const id = e.target?.id;
        if (!id) return;
        compute();
      });
    });

    if (qs('#addWindowBtn')) qs('#addWindowBtn').addEventListener('click', () => addWindow());
    qs('#shareBtn').addEventListener('click', copyLink);
    qs('#printBtn').addEventListener('click', ()=>window.print());

    // Boot
    window.addEventListener('DOMContentLoaded', () => {
        initDefaults();
        const loadedFromUrl = loadFromUrlParams();
        if (!loadedFromUrl) addWindow();
        loadFromLocalStorage();        
        compute();
    });
  </script>
</body>
</html>